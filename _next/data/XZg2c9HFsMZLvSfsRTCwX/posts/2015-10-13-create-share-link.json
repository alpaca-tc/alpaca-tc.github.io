{"pageProps":{"post":{"id":"2015-10-13-create-share-link","title":"シェアリンクの作り方","date":"2015-10-13 21:31","content":"<p>最近Railsでシェアリンクを実装したので紹介します。\nみんなはどうやって実装しているのだろう？</p>\n<p>↓こんなURLね</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">https://alpaca.tc/shares/uIx90S</code></pre></div>\n<p>実装面白かったので紹介してみます＞＜</p>\n<!-- more -->\n<p>ちなみに僕の実装方法は、ポリモーフィックなカラムを持つ<code>share_links</code>テーブルを作って、シェアしたいrecordを紐付けることで実現した。</p>\n<p>ユニークなキーが必要なため<code>id</code>を使用していてに、2度クエリを発行しているのだけど、パフォーマンスを気にするなら<code>LAST_INSERT_ID</code>を使って一度のクエリで済ます方が良い。</p>\n<div class=\"remark-highlight\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">CreateShareLinks</span> <span class=\"token operator\">&#x3C;</span> <span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Migration</span>\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">change</span></span>\n    create_table <span class=\"token symbol\">:share_links</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>t<span class=\"token operator\">|</span>\n      t<span class=\"token punctuation\">.</span>references <span class=\"token symbol\">:sharable</span><span class=\"token punctuation\">,</span> polymorphic<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span>\n      t<span class=\"token punctuation\">.</span>string <span class=\"token symbol\">:uuid</span>\n      t<span class=\"token punctuation\">.</span>timestamps null<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span>\n\n      t<span class=\"token punctuation\">.</span>index <span class=\"token symbol\">:uuid</span><span class=\"token punctuation\">,</span> unique<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span>\n      t<span class=\"token punctuation\">.</span>index <span class=\"token punctuation\">[</span><span class=\"token symbol\">:sharable_type</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:sharable_id</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> unique<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n</code></pre></div>\n<div class=\"remark-highlight\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># lib/share_link_uuid.rb</span>\n<span class=\"token keyword\">require</span> <span class=\"token string\">'digest/sha2'</span>\n\n<span class=\"token keyword\">module</span> <span class=\"token constant\">ShareLinkUuid</span>\n  <span class=\"token comment\"># URLで使用可能な文字列</span>\n  <span class=\"token constant\">HEX64</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token string\">'0'</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token string\">'9'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token string\">'A'</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token string\">'Z'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token string\">'z'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'_'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>freeze\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">generate</span></span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">)</span>\n    digest <span class=\"token operator\">=</span> <span class=\"token constant\">Digest</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">SHA512</span><span class=\"token punctuation\">.</span>hexdigest<span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">.</span>to_s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to_i<span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to_s<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span>\n\n    uuid <span class=\"token operator\">=</span> digest<span class=\"token punctuation\">.</span>gsub<span class=\"token punctuation\">(</span><span class=\"token regex\">/\\d{2}/</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>token<span class=\"token operator\">|</span>\n      <span class=\"token constant\">HEX64</span><span class=\"token punctuation\">[</span>token<span class=\"token punctuation\">.</span>to_i<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to_s<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to_i<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">end</span>\n\n    uuid<span class=\"token punctuation\">[</span><span class=\"token number\">0.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token comment\"># app/models/share_link.rb</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ShareLink</span> <span class=\"token operator\">&#x3C;</span> <span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Base</span>\n  <span class=\"token constant\">UUID_LENGTH</span> <span class=\"token operator\">=</span> <span class=\"token number\">6</span>\n\n  belongs_to <span class=\"token symbol\">:sharable</span><span class=\"token punctuation\">,</span> polymorphic<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> required<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span>\n  validates <span class=\"token symbol\">:uuid</span><span class=\"token punctuation\">,</span> absence<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">:</span> <span class=\"token symbol\">:new_record?</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> presence<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">:</span> <span class=\"token symbol\">:persisted?</span> <span class=\"token punctuation\">}</span>\n  validates <span class=\"token symbol\">:sharable_type</span><span class=\"token punctuation\">,</span> inclusion<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">in</span><span class=\"token punctuation\">:</span> <span class=\"token string\">%w(Item)</span> <span class=\"token punctuation\">}</span>\n  after_create <span class=\"token symbol\">:save_uuid</span>\n\n  <span class=\"token keyword\">private</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">save_uuid</span></span>\n    <span class=\"token variable\">@uuid_length</span> <span class=\"token operator\">||</span><span class=\"token operator\">=</span> <span class=\"token constant\">UUID_LENGTH</span>\n    update_uuid<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token variable\">@uuid_length</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">rescue</span> <span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">RecordNotUnique</span>\n    <span class=\"token comment\"># UUIDの長さを増やして再試行</span>\n    <span class=\"token variable\">@uuid_length</span> <span class=\"token operator\">+</span><span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n    <span class=\"token keyword\">retry</span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">update_uuid</span></span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>length<span class=\"token punctuation\">)</span>\n    uuid <span class=\"token operator\">=</span> <span class=\"token constant\">ShareLinkUuid</span><span class=\"token punctuation\">.</span>generate<span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">)</span>\n    update<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>uuid<span class=\"token punctuation\">:</span> uuid<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token keyword\">module</span> <span class=\"token constant\">Sharable</span>\n    <span class=\"token keyword\">extend</span> <span class=\"token constant\">ActiveSupport</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Concern</span>\n\n    included <span class=\"token keyword\">do</span>\n      has_one <span class=\"token symbol\">:share_link</span><span class=\"token punctuation\">,</span> as<span class=\"token punctuation\">:</span> <span class=\"token symbol\">:sharable</span><span class=\"token punctuation\">,</span> dependent<span class=\"token punctuation\">:</span> <span class=\"token symbol\">:destroy</span>\n\n      scope <span class=\"token symbol\">:shared</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span> joins<span class=\"token punctuation\">(</span><span class=\"token symbol\">:share_link</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n      scope <span class=\"token symbol\">:not_shared</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span> where<span class=\"token punctuation\">.</span><span class=\"token keyword\">not</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">:</span> shared<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token comment\"># app/models/item.rb</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Item</span> \n  <span class=\"token keyword\">include</span> <span class=\"token constant\">ShareLink</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Sharable</span>\n<span class=\"token keyword\">end</span>\n</code></pre></div>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">Rails.application.routes.draw do\n  resources :shares, only: [:create], controller: :share_links\nend\n\nclass ShareLinksController &#x26;lt; ApplicationController\n  def create\n    @share_link = ShareLink.new(share_link_params)\n\n    if @share_link.save\n      render format: :json\n    else\n      render :error\n    end\n  end\n\n  private\n\n  def share_link_params\n    params.require(:share_link).permit(\n      :sharable_type, :sharable_id\n    ).merge(user: current_user)\n  end\nend</code></pre></div>\n<p>うーん、もっと良い方法ありそうだナ...</p>"}},"__N_SSG":true}