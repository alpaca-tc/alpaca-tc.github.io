<!DOCTYPE html><html lang="ja"><head><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-44082439-2"></script><script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());

              gtag('config', 'UA-44082439-2');
            </script><title>Rustでブラウザからバイナリをパースする - alpaca-tc</title><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="title" content="Rustでブラウザからバイナリをパースする - alpaca-tc"/><meta name="description" content="この記事は[Rust Advent Calendar 2020](https://qiita.com/advent-calendar/2020/rust) 21日目の記事です。お仕事のメインはRuby/TypeScriptを使っていますが、新しいことを学びたいなーと思って、Rustを勉強し始めてみました。  今回はWe"/><link rel="shortcut icon" href="/images/common/favicon.ico" type="image/x-icon"/><meta name="google-site-verification" content="thSL3cUT7BV1-AENglRFIF-kv6I85JJ6_iUGAU8GaQI"/><meta property="og:title" content="Rustでブラウザからバイナリをパースする - alpaca-tc"/><meta property="og:locale" content="ja_JP"/><meta property="og:image" content="https://alpaca.tc/og-images/2020-12-21-rust-advent-calendar.png"/><meta property="og:type" content="blog"/><meta property="og:url" content="https://alpaca.tc/posts/2020-12-21-rust-advent-calendar"/><meta property="og:site_name" content="alpaca-tc"/><meta property="og:description" content="この記事は[Rust Advent Calendar 2020](https://qiita.com/advent-calendar/2020/rust) 21日目の記事です。お仕事のメインはRuby/TypeScriptを使っていますが、新しいことを学びたいなーと思って、Rustを勉強し始めてみました。  今回はWe"/><meta property="fb:app_id" content="224701561024840"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Rustでブラウザからバイナリをパースする - alpaca-tc"/><meta name="twitter:description" content="この記事は[Rust Advent Calendar 2020](https://qiita.com/advent-calendar/2020/rust) 21日目の記事です。お仕事のメインはRuby/TypeScriptを使っていますが、新しいことを学びたいなーと思って、Rustを勉強し始めてみました。  今回はWe"/><meta name="twitter:image" content="https://alpaca.tc/og-images/2020-12-21-rust-advent-calendar.png"/><meta name="twitter:site" content="@alpaca_tc"/><meta name="twitter:creator" content="@alpaca_tc"/><meta name="next-head-count" content="23"/><link rel="preload" href="/_next/static/css/12751740b451bc95eca1.css" as="style"/><link rel="stylesheet" href="/_next/static/css/12751740b451bc95eca1.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/webpack-f3dce3d8b4ce9b0f1815.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework-159e6bcedf8862d2ffb2.js" as="script"/><link rel="preload" href="/_next/static/chunks/679-111107f27ddf1c4ca974.js" as="script"/><link rel="preload" href="/_next/static/chunks/778-afdc0fd1e03e237f558b.js" as="script"/><link rel="preload" href="/_next/static/chunks/main-b585fbee1813a2c23693.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-8034d102492099615e81.js" as="script"/><link rel="preload" href="/_next/static/chunks/a9a7754c-5d9f4b6dc0a2d6223edb.js" as="script"/><link rel="preload" href="/_next/static/chunks/968-ae4b333367f0f3fb3947.js" as="script"/><link rel="preload" href="/_next/static/chunks/625-b9d82b074d475791488b.js" as="script"/><link rel="preload" href="/_next/static/chunks/711-e65fb688a02629edb0f4.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-87066f419f74712c15f1.js" as="script"/></head><body class="font-sans text-black leading-tight antialiased"><div id="__next"><div class="py-8 lg:py-16 px-6 md:px-16 lg:px-24 "><div class="relative z-20 flex justify-between items-center"><div class="flex lg:flex md:block items-center max-w-full"><div class="mb-0 md:mb-4 lg:mb-0 flex flex-shrink-0 pr-4 md:pr-6 lg:pr-12"><div class="inline-block h-10 w-10 md:h-12 md:w-12 lg:h-20 lg:w-20"><a class="flex items-center no-underline"><img class="rounded-full" src="/images/profile.jpg" width="100%" height="100%"/></a></div></div><div><a class="block text-black no-underline font-bold text-xl lg:text-3xl font-extrabold leading-none lg:leading-tight" href="/">alpaca-tc</a><div class="hidden md:flex mt-3 lg:mt-4 uppercase tracking-wide text-xs space-x-6"><a class="text-black font-semibold no-underline hover:text-black" href="/">Posts</a><a class="text-gray-500 font-semibold no-underline hover:text-black" href="/about_me">About Me</a><a class="text-gray-500 font-semibold no-underline hover:text-black" href="/works">Works</a><a href="https://github.com/alpaca-tc" class="text-gray-500 font-semibold no-underline hover:text-black" target="_blank" rel="noreferrer">GitHub</a><a href="https://twitter.com/alpaca_tc" class="text-gray-500 font-semibold no-underline hover:text-black" target="_blank" rel="noreferrer">Twitter</a></div></div></div><div class="block md:hidden"><button class="block"><svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="text-black h-6 w-6 block"><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"></path></svg><svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="text-black h-6 w-6 hidden"><path d="M10 8.586L2.929 1.515 1.515 2.929 8.586 10l-7.071 7.071 1.414 1.414L10 11.414l7.071 7.071 1.414-1.414L11.414 10l7.071-7.071-1.414-1.414L10 8.586z"></path></svg></button></div></div><div class="md:hidden z-10 bg-white fixed pt-24 pin block hidden"><div class="space-y-8 overflow-y-auto pt-6 pb-8 px-12 max-h-full overflow-y-auto"><a class="block text-black font-bold no-underline" href="/">Posts</a><a class="block text-black font-bold no-underline" href="/about_me">About Me</a><a class="block text-black font-bold no-underline" href="/works">Works</a><a href="https://github.com/alpaca-tc" class="block text-black font-bold no-underline" target="_blank" rel="noreferrer">GitHub</a><a href="https://twitter.com/alpaca_tc" class="block text-black font-bold no-underline" target="_blank" rel="noreferrer">Twitter</a></div></div><div class="lg:pl-32 mt-12"><article class="max-w-3xl md:mt-6 rounded-xl mx-auto bg-white dark:bg-cool-gray-800"><div class="text-grey-dark uppercase font-semibold text-xs tracking-wide">2020-12-21</div><h1 class="text-2xl font-extrabold text-black leading-tight mt-1 mb-6">Rustでブラウザからバイナリをパースする</h1><div class="prose max-w-3xl mx-auto dark:text-cool-gray-100"><p>この記事は<a href="https://qiita.com/advent-calendar/2020/rust">Rust Advent Calendar 2020</a> 21日目の記事です。</p>
<p>お仕事のメインはRuby/TypeScriptを使っていますが、新しいことを学びたいなーと思って、Rustを勉強し始めてみました。<br>
今回はWebAssemblyを使って、ブラウザからバイナリファイルをパースする処理を書いてみます。</p>
<h2>RustをWebAssemblyに変換する</h2>
<p>この手の記事は沢山あるので、ざっくりやり方だけ書いておきます。<br>
<a href="https://github.com/rustwasm/wasm-bindgen"><code>wasm-bindgen</code></a>と<a href="https://github.com/rustwasm/wasm-pack"><code>wasm-pack</code></a>をインストールして、</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown"># Cargo.toml
[package]
name = &#x26;quot;app&#x26;quot;
version = &#x26;quot;0.0.1&#x26;quot;
edition = &#x26;quot;2018&#x26;quot;

[lib]
crate-type = [&#x26;quot;cdylib&#x26;quot;]

[dependencies]
wasm-bindgen = &#x26;quot;0.2.63&#x26;quot;</code></pre></div>
<div class="remark-highlight"><pre class="language-rust"><code class="language-rust"># src<span class="token operator">/</span>lib<span class="token punctuation">.</span>rs
<span class="token keyword">use</span> <span class="token namespace">wasm_bindgen<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[wasm_bindgen]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">ApplicationRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[wasm_bindgen]</span>
<span class="token keyword">impl</span> <span class="token class-name">ApplicationRunner</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<div class="remark-highlight"><pre class="language-html"><code class="language-html"># index.html
<span class="token doctype"><span class="token punctuation">&#x3C;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>module<span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword module">import</span> <span class="token imports">init<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">ApplicationRunner</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.js'</span>

      <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">await</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token string">'/app.wasm'</span><span class="token punctuation">)</span>
        <span class="token keyword">new</span> <span class="token class-name">ApplicationRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>html</span><span class="token punctuation">></span></span>
</code></pre></div>
<p>あとは <code>wasm-pack</code> を使ってコンパイルすれば完成です。
めちゃ簡単。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">$ wasm-pack build --no-typescript --dev --target web --out-dir ./public</code></pre></div>
<h2>ファイルを読み込む</h2>
<p>続いて、ブラウザから、ファイルを指定してRustにパースさせる導線を作っていきます。<br>
先ほど定義した <code>ApplicationRunner</code> をnewしたタイミングで、イベントをlistenしたDOMをレンダリングしておきます。</p>
<p>DOMの生成には <code>virtual_dom_rs</code> と <code>web_sys</code> と <code>js_sys</code> を使います。<br>
すごく単純な例では、こんな感じでDOMをマウントすることができます。</p>
<div class="remark-highlight"><pre class="language-rust"><code class="language-rust"><span class="token keyword">let</span> vdom <span class="token operator">=</span> <span class="token macro property">html!</span> <span class="token punctuation">{</span> <span class="token operator">&#x3C;</span>div<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> window <span class="token operator">=</span> <span class="token namespace">web_sys<span class="token punctuation">::</span></span><span class="token function">window</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> dom_updater <span class="token operator">=</span> <span class="token class-name">DomUpdater</span><span class="token punctuation">::</span><span class="token function">new_append_to_mount</span><span class="token punctuation">(</span>vdom<span class="token punctuation">,</span> <span class="token operator">&#x26;</span>window<span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dom_updater<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>vdom<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>今回はファイルの読み込みをしたいので、vdomの中身を書き換えて、inputタグにイベントを仕込んだDOMにしてみます。</p>
<div class="remark-highlight"><pre class="language-rust"><code class="language-rust"><span class="token macro property">html!</span> <span class="token punctuation">{</span>
  <span class="token operator">&#x3C;</span>input
    <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">"file"</span>
    onchange<span class="token operator">=</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>event<span class="token punctuation">:</span> <span class="token namespace">web_sys<span class="token punctuation">::</span></span><span class="token class-name">InputEvent</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> target <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> input <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">dyn_ref</span><span class="token punctuation">::</span><span class="token operator">&#x3C;</span><span class="token class-name">HtmlInputElement</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> files <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">files</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> file <span class="token operator">=</span> files<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> file_reader <span class="token operator">=</span> <span class="token namespace">web_sys<span class="token punctuation">::</span></span><span class="token class-name">FileReader</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        file_reader<span class="token punctuation">.</span><span class="token function">read_as_array_buffer</span><span class="token punctuation">(</span><span class="token operator">&#x26;</span>file<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> onload <span class="token operator">=</span> <span class="token class-name">Closure</span><span class="token punctuation">::</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>event<span class="token punctuation">:</span> <span class="token class-name">Event</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> file_reader<span class="token punctuation">:</span> <span class="token class-name">FileReader</span> <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dyn_into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> file <span class="token operator">=</span> file_reader<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token namespace">js_sys<span class="token punctuation">::</span></span><span class="token class-name">Uint8Array</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&#x26;</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">let</span> <span class="token keyword">mut</span> bytes <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            file<span class="token punctuation">.</span><span class="token function">copy_to</span><span class="token punctuation">(</span><span class="token operator">&#x26;</span><span class="token keyword">mut</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// ここにファイルの中身のパースを開始する処理を追加する</span>
            <span class="token function">do_something</span><span class="token punctuation">(</span><span class="token operator">&#x26;</span>bytes<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token class-name">Box</span><span class="token operator">&#x3C;</span><span class="token class-name">FnMut</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        file_reader<span class="token punctuation">.</span><span class="token function">set_onload</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span>onload<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unchecked_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        onload<span class="token punctuation">.</span><span class="token function">forget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token operator">></span>
<span class="token punctuation">}</span>
</code></pre></div>
<h2>ファイルをパースする</h2>
<p>ファイルの読み込みする処理が書けたので、次はファイルをパースしていきます。<br>
単にバイナリを読んでいくだけであれば <code>std::io::Cursor</code> だけでいけますが、little endianを読み込もうとするとやや操作が面倒です。</p>
<p>そこで、<a href="https://docs.rs/byteorder/1.3.4/byteorder/">byteorder</a>を使って読み込んでいきます。<br>
下記の例では、今後UTF8の文字列変換や特定のバイナリに特化した読み込みに対応する時に拡張しやすくするために、読み取り用のwrapperを用意しました。<br>
単純なzipファイルのパースであれば、file name fieldやextra fieldなどの可変長のfieldがあるため、指定長でvecやstringを返すメソッドも用意するといいかもしれません。</p>
<div class="remark-highlight"><pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">byteorder<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">BigEndian</span><span class="token punctuation">,</span> <span class="token class-name">ByteOrder</span><span class="token punctuation">,</span> <span class="token class-name">LittleEndian</span><span class="token punctuation">,</span> <span class="token class-name">ReadBytesExt</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Binary</span><span class="token operator">&#x3C;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">{</span>
    cursor<span class="token punctuation">:</span> <span class="token class-name">Cursor</span><span class="token operator">&#x3C;</span><span class="token operator">&#x26;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&#x3C;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token class-name">Binary</span><span class="token operator">&#x3C;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>bytes<span class="token punctuation">:</span> <span class="token operator">&#x26;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Binary</span> <span class="token punctuation">{</span>
        <span class="token class-name">Binary</span> <span class="token punctuation">{</span>
            cursor<span class="token punctuation">:</span> <span class="token class-name">Cursor</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">position</span><span class="token punctuation">(</span><span class="token operator">&#x26;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">u64</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>cursor<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">read_little_u16</span><span class="token punctuation">(</span><span class="token operator">&#x26;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&#x3C;</span><span class="token keyword">u16</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>cursor<span class="token punctuation">.</span><span class="token function">read_u16</span><span class="token punctuation">::</span><span class="token operator">&#x3C;</span><span class="token class-name">LittleEndian</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">read_little_u32</span><span class="token punctuation">(</span><span class="token operator">&#x26;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&#x3C;</span><span class="token keyword">u32</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>cursor<span class="token punctuation">.</span><span class="token function">read_u32</span><span class="token punctuation">::</span><span class="token operator">&#x3C;</span><span class="token class-name">LittleEndian</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">read_u16</span><span class="token punctuation">(</span><span class="token operator">&#x26;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&#x3C;</span><span class="token keyword">u16</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>cursor<span class="token punctuation">.</span><span class="token function">read_u16</span><span class="token punctuation">::</span><span class="token operator">&#x3C;</span><span class="token class-name">BigEndian</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">read_u32</span><span class="token punctuation">(</span><span class="token operator">&#x26;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&#x3C;</span><span class="token keyword">u32</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>cursor<span class="token punctuation">.</span><span class="token function">read_u32</span><span class="token punctuation">::</span><span class="token operator">&#x3C;</span><span class="token class-name">BigEndian</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">read_i16</span><span class="token punctuation">(</span><span class="token operator">&#x26;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&#x3C;</span><span class="token keyword">i16</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>cursor<span class="token punctuation">.</span><span class="token function">read_i16</span><span class="token punctuation">::</span><span class="token operator">&#x3C;</span><span class="token class-name">BigEndian</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">read_i32</span><span class="token punctuation">(</span><span class="token operator">&#x26;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&#x3C;</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>cursor<span class="token punctuation">.</span><span class="token function">read_i32</span><span class="token punctuation">::</span><span class="token operator">&#x3C;</span><span class="token class-name">BigEndian</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h3>パース処理を書いていく</h3>
<p>過去にRubyでpsdやzipのパーサを書いたことがあるのですが、これらは仕様書通りの単純な構造だったので、同様に先頭から読み込んでstructに詰めていくだけでいけそうです。<br>
今回はzipのヘッダーをパースする処理の書いてみます。</p>
<div class="remark-highlight"><pre class="language-rust"><code class="language-rust"><span class="token comment">// == LocalFileHeader</span>
<span class="token comment">//</span>
<span class="token comment">// local file header signature     4 bytes  (0x04034b50)</span>
<span class="token comment">// version needed to extract       2 bytes</span>
<span class="token comment">// general purpose bit flag        2 bytes</span>
<span class="token comment">// compression method              2 bytes</span>
<span class="token comment">// last mod file time              2 bytes</span>
<span class="token comment">// last mod file date              2 bytes</span>
<span class="token comment">// crc-32                          4 bytes</span>
<span class="token comment">// compressed size                 4 bytes</span>
<span class="token comment">// uncompressed size               4 bytes</span>
<span class="token comment">// file name length                2 bytes</span>
<span class="token comment">// extra field length              2 bytes</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">LocalFileHeader</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> signature<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> version<span class="token punctuation">:</span> <span class="token keyword">u16</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> general_purpose_bit_flag<span class="token punctuation">:</span> <span class="token keyword">u16</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> compression_method<span class="token punctuation">:</span> <span class="token keyword">u16</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> last_modified_file_time<span class="token punctuation">:</span> <span class="token keyword">u16</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> last_modified_file_date<span class="token punctuation">:</span> <span class="token keyword">u16</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> crc_32<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> compressed_size<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> uncompressed_size<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> file_name_length<span class="token punctuation">:</span> <span class="token keyword">u16</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> extra_field_length<span class="token punctuation">:</span> <span class="token keyword">u16</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">LocalFileHeader</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">from_bytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">:</span> <span class="token operator">&#x26;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&#x3C;</span><span class="token class-name">LocalFileHeader</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> binary <span class="token operator">=</span> <span class="token class-name">Binary</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> signature <span class="token operator">=</span> binary<span class="token punctuation">.</span><span class="token function">read_little_u32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> version <span class="token operator">=</span> binary<span class="token punctuation">.</span><span class="token function">read_little_u16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> general_purpose_bit_flag <span class="token operator">=</span> binary<span class="token punctuation">.</span><span class="token function">read_little_u16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> compression_method <span class="token operator">=</span> binary<span class="token punctuation">.</span><span class="token function">read_little_u16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> last_modified_file_time <span class="token operator">=</span> binary<span class="token punctuation">.</span><span class="token function">read_u16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> last_modified_file_date <span class="token operator">=</span> binary<span class="token punctuation">.</span><span class="token function">read_u16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> crc_32 <span class="token operator">=</span> binary<span class="token punctuation">.</span><span class="token function">read_u32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> compressed_size <span class="token operator">=</span> binary<span class="token punctuation">.</span><span class="token function">read_u32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> uncompressed_size <span class="token operator">=</span> binary<span class="token punctuation">.</span><span class="token function">read_u32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> file_name_length <span class="token operator">=</span> binary<span class="token punctuation">.</span><span class="token function">read_u16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> extra_field_length <span class="token operator">=</span> binary<span class="token punctuation">.</span><span class="token function">read_u16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">LocalFileHeader</span> <span class="token punctuation">{</span>
            signature<span class="token punctuation">,</span>
            version<span class="token punctuation">,</span>
            general_purpose_bit_flag<span class="token punctuation">,</span>
            compression_method<span class="token punctuation">,</span>
            last_modified_file_time<span class="token punctuation">:</span> last_modified_file_time<span class="token punctuation">,</span>
            last_modified_file_date<span class="token punctuation">,</span>
            crc_32<span class="token punctuation">,</span>
            compressed_size<span class="token punctuation">,</span>
            uncompressed_size<span class="token punctuation">,</span>
            file_name_length<span class="token punctuation">,</span>
            extra_field_length<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>とても簡単ですね。</p>
<h2>パースした内容をHTMLにレンダリングする</h2>
<p>では、最後にパースした内容をHTMLへレンダリングしてみます。<br>
諸々省略しているのでこのままでは動きませんが、雰囲気としてはこんな感じでDOMを生成して、初めに作ったDomUpdaterのupdateに返り値のVirtualNodeを渡せばOKです。</p>
<div class="remark-highlight"><pre class="language-rust"><code class="language-rust"><span class="token comment">// let local_file_header = LocalFileHeader::from_bytes(&#x26;bytes)</span>
<span class="token comment">// let vdom = render(...)</span>
<span class="token comment">// dom_updater.update(vdom); という感じで使う</span>
<span class="token keyword">fn</span> <span class="token function-definition function">render</span><span class="token punctuation">(</span>local_file_header<span class="token punctuation">:</span> <span class="token operator">&#x26;</span><span class="token class-name">LocalFileHeader</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">VirtualNode</span> <span class="token punctuation">{</span>
    <span class="token macro property">html!</span> <span class="token punctuation">{</span>
      <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>span<span class="token operator">></span>
          signature<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"{:X}"</span><span class="token punctuation">,</span> local_file_header<span class="token punctuation">.</span>signature<span class="token punctuation">)</span><span class="token punctuation">}</span>
          <span class="token operator">&#x3C;</span>br<span class="token operator">></span>
          version<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"{:X}"</span><span class="token punctuation">,</span> local_file_header<span class="token punctuation">.</span>version<span class="token punctuation">)</span><span class="token punctuation">}</span>
          <span class="token operator">&#x3C;</span>br<span class="token operator">></span>
          general_purpose_bit_flag<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"{:X}"</span><span class="token punctuation">,</span> local_file_header<span class="token punctuation">.</span>general_purpose_bit_flag<span class="token punctuation">)</span><span class="token punctuation">}</span>
          <span class="token operator">&#x3C;</span>br<span class="token operator">></span>
          compression_method<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"{:X}"</span><span class="token punctuation">,</span> local_file_header<span class="token punctuation">.</span>compression_method<span class="token punctuation">)</span><span class="token punctuation">}</span>
          <span class="token operator">&#x3C;</span>br<span class="token operator">></span>
          last_modified_file_time<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"{:X}"</span><span class="token punctuation">,</span> local_file_header<span class="token punctuation">.</span>last_modified_file_time<span class="token punctuation">)</span><span class="token punctuation">}</span>
          <span class="token operator">&#x3C;</span>br<span class="token operator">></span>
          last_modified_file_date<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"{:X}"</span><span class="token punctuation">,</span> local_file_header<span class="token punctuation">.</span>last_modified_file_date<span class="token punctuation">)</span><span class="token punctuation">}</span>
          <span class="token operator">&#x3C;</span>br<span class="token operator">></span>
          crc_32<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"{:X}"</span><span class="token punctuation">,</span> local_file_header<span class="token punctuation">.</span>crc_32<span class="token punctuation">)</span><span class="token punctuation">}</span>
          <span class="token operator">&#x3C;</span>br<span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span>span<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h2>まとめ</h2>
<p>今回は<code>wasm-bindgen</code>を使ってブラウザでファイルをパースする処理を書いてみました。<br>
もう少しパース処理を作り込んでいけば、画像変換やzipの再圧縮などいろいろな処理を書くことができそうです。</p>
<p>可能であれば、仕事でもちゃんとRust書いてみたいのでReal Worldの活用事例をもっと知りたいなぁと思いました(´・ω・｀)</p></div><div class="flex justify-end mt-4 h-10 bg"><a href="https://twitter.com/share?url=https%3A%2F%2Falpaca.tc%2Fposts%2F2020-12-21-rust-advent-calendar&amp;text=Rust%E3%81%A7%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E3%81%8B%E3%82%89%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA%E3%82%92%E3%83%91%E3%83%BC%E3%82%B9%E3%81%99%E3%82%8B+%7C+" data-url="" data-via="" data-width="120" data-counturl="" rel="nofollow noopener noreferrer" target="_blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" class="svg-inline--fa fa-twitter fa-w-16 h-7 text-gray-400 hover:text-black transition duration-300 cursor-pointer" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a href="https://www.facebook.com/share.php?u=https%3A%2F%2Falpaca.tc%2Fposts%2F2020-12-21-rust-advent-calendar" class="ml-4" data-url="" data-via="" data-width="120" data-counturl="" rel="nofollow noopener noreferrer" target="_blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="facebook" class="svg-inline--fa fa-facebook fa-w-16 h-7 text-gray-400 hover:text-black transition duration-300 cursor-pointer" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"></path></svg></a></div></article><aside class="max-w-3xl md:mt-6 mx-auto bg-white"><div class="border-solid border-t-1 border-b-1 border-gray-900"><a class="block lg:flex-half text-gray-700 transition duration-300 hover:text-gray-900 mt-1 mb-1 pt-4 pb-4 border border-solid border-l-0 border-r-0 border-b-0" href="/posts/2020-12-18-kamipo-san-no-advice-to-kyoten-wo-mataida-benkyou-kai"><div><span class="block text-gray-500 uppercase font-semibold text-xs tracking-wide mb-2 no-underline">次の記事</span><span class="block text-gray-500 uppercase text-xs tracking-wide no-underline">2020-12-18</span><div class="underline">kamipoさんのアドバイスと拠点を跨いだ勉強会</div></div></a></div></aside></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"id":"2020-12-21-rust-advent-calendar","title":"Rustでブラウザからバイナリをパースする","date":"2020-12-21 17:21","content":"\u003cp\u003eこの記事は\u003ca href=\"https://qiita.com/advent-calendar/2020/rust\"\u003eRust Advent Calendar 2020\u003c/a\u003e 21日目の記事です。\u003c/p\u003e\n\u003cp\u003eお仕事のメインはRuby/TypeScriptを使っていますが、新しいことを学びたいなーと思って、Rustを勉強し始めてみました。\u003cbr\u003e\n今回はWebAssemblyを使って、ブラウザからバイナリファイルをパースする処理を書いてみます。\u003c/p\u003e\n\u003ch2\u003eRustをWebAssemblyに変換する\u003c/h2\u003e\n\u003cp\u003eこの手の記事は沢山あるので、ざっくりやり方だけ書いておきます。\u003cbr\u003e\n\u003ca href=\"https://github.com/rustwasm/wasm-bindgen\"\u003e\u003ccode\u003ewasm-bindgen\u003c/code\u003e\u003c/a\u003eと\u003ca href=\"https://github.com/rustwasm/wasm-pack\"\u003e\u003ccode\u003ewasm-pack\u003c/code\u003e\u003c/a\u003eをインストールして、\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e# Cargo.toml\n[package]\nname = \u0026#x26;quot;app\u0026#x26;quot;\nversion = \u0026#x26;quot;0.0.1\u0026#x26;quot;\nedition = \u0026#x26;quot;2018\u0026#x26;quot;\n\n[lib]\ncrate-type = [\u0026#x26;quot;cdylib\u0026#x26;quot;]\n\n[dependencies]\nwasm-bindgen = \u0026#x26;quot;0.2.63\u0026#x26;quot;\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-rust\"\u003e\u003ccode class=\"language-rust\"\u003e# src\u003cspan class=\"token operator\"\u003e/\u003c/span\u003elib\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ers\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token namespace\"\u003ewasm_bindgen\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003eprelude\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token attribute attr-name\"\u003e#[wasm_bindgen]\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"token type-definition class-name\"\u003eApplicationRunner\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token attribute attr-name\"\u003e#[wasm_bindgen]\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eimpl\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eApplicationRunner\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003enew\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003e# index.html\n\u003cspan class=\"token doctype\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;!\u003c/span\u003e\u003cspan class=\"token doctype-tag\"\u003eDOCTYPE\u003c/span\u003e \u003cspan class=\"token name\"\u003ehtml\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ehtml\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ehead\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003emeta\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003echarset\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003eUTF-8\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ehead\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ebody\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003escript\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003etype\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e'\u003c/span\u003emodule\u003cspan class=\"token punctuation\"\u003e'\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token script\"\u003e\u003cspan class=\"token language-javascript\"\u003e\n      \u003cspan class=\"token keyword module\"\u003eimport\u003c/span\u003e \u003cspan class=\"token imports\"\u003einit\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eApplicationRunner\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token keyword module\"\u003efrom\u003c/span\u003e \u003cspan class=\"token string\"\u003e'./app.js'\u003c/span\u003e\n\n      \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword control-flow\"\u003eawait\u003c/span\u003e \u003cspan class=\"token function\"\u003einit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'/app.wasm'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eApplicationRunner\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003escript\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ebody\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ehtml\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eあとは \u003ccode\u003ewasm-pack\u003c/code\u003e を使ってコンパイルすれば完成です。\nめちゃ簡単。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e$ wasm-pack build --no-typescript --dev --target web --out-dir ./public\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eファイルを読み込む\u003c/h2\u003e\n\u003cp\u003e続いて、ブラウザから、ファイルを指定してRustにパースさせる導線を作っていきます。\u003cbr\u003e\n先ほど定義した \u003ccode\u003eApplicationRunner\u003c/code\u003e をnewしたタイミングで、イベントをlistenしたDOMをレンダリングしておきます。\u003c/p\u003e\n\u003cp\u003eDOMの生成には \u003ccode\u003evirtual_dom_rs\u003c/code\u003e と \u003ccode\u003eweb_sys\u003c/code\u003e と \u003ccode\u003ejs_sys\u003c/code\u003e を使います。\u003cbr\u003e\nすごく単純な例では、こんな感じでDOMをマウントすることができます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-rust\"\u003e\u003ccode class=\"language-rust\"\u003e\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e vdom \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token macro property\"\u003ehtml!\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003ediv\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003ediv\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e window \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token namespace\"\u003eweb_sys\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003ewindow\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e dom_updater \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eDomUpdater\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token function\"\u003enew_append_to_mount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003evdom\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003ewindow\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edocument\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ebody\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\ndom_updater\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eupdate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003evdom\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e今回はファイルの読み込みをしたいので、vdomの中身を書き換えて、inputタグにイベントを仕込んだDOMにしてみます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-rust\"\u003e\u003ccode class=\"language-rust\"\u003e\u003cspan class=\"token macro property\"\u003ehtml!\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003einput\n    \u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"file\"\u003c/span\u003e\n    onchange\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token keyword\"\u003emove\u003c/span\u003e \u003cspan class=\"token closure-params\"\u003e\u003cspan class=\"token closure-punctuation punctuation\"\u003e|\u003c/span\u003eevent\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token namespace\"\u003eweb_sys\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eInputEvent\u003c/span\u003e\u003cspan class=\"token closure-punctuation punctuation\"\u003e|\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e target \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e event\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003etarget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e input \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e target\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edyn_ref\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eHtmlInputElement\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e files \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e input\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efiles\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e file \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e files\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eitem\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e file_reader \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token namespace\"\u003eweb_sys\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eFileReader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token function\"\u003enew\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        file_reader\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_as_array_buffer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003efile\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"token keyword\"\u003emut\u003c/span\u003e onload \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eClosure\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token function\"\u003ewrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eBox\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token function\"\u003enew\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003emove\u003c/span\u003e \u003cspan class=\"token closure-params\"\u003e\u003cspan class=\"token closure-punctuation punctuation\"\u003e|\u003c/span\u003eevent\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eEvent\u003c/span\u003e\u003cspan class=\"token closure-punctuation punctuation\"\u003e|\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e file_reader\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eFileReader\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e event\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003etarget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edyn_into\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e file \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e file_reader\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eresult\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e file \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token namespace\"\u003ejs_sys\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eUint8Array\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token function\"\u003enew\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003efile\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"token keyword\"\u003emut\u003c/span\u003e bytes \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token macro property\"\u003evec!\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e file\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003elength\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eusize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            file\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecopy_to\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003emut\u003c/span\u003e bytes\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"token comment\"\u003e// ここにファイルの中身のパースを開始する処理を追加する\u003c/span\u003e\n            \u003cspan class=\"token function\"\u003edo_something\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003ebytes\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBox\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eFnMut\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e_\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        file_reader\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eset_onload\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eSome\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eonload\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eas_ref\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunchecked_ref\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        onload\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eforget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eファイルをパースする\u003c/h2\u003e\n\u003cp\u003eファイルの読み込みする処理が書けたので、次はファイルをパースしていきます。\u003cbr\u003e\n単にバイナリを読んでいくだけであれば \u003ccode\u003estd::io::Cursor\u003c/code\u003e だけでいけますが、little endianを読み込もうとするとやや操作が面倒です。\u003c/p\u003e\n\u003cp\u003eそこで、\u003ca href=\"https://docs.rs/byteorder/1.3.4/byteorder/\"\u003ebyteorder\u003c/a\u003eを使って読み込んでいきます。\u003cbr\u003e\n下記の例では、今後UTF8の文字列変換や特定のバイナリに特化した読み込みに対応する時に拡張しやすくするために、読み取り用のwrapperを用意しました。\u003cbr\u003e\n単純なzipファイルのパースであれば、file name fieldやextra fieldなどの可変長のfieldがあるため、指定長でvecやstringを返すメソッドも用意するといいかもしれません。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-rust\"\u003e\u003ccode class=\"language-rust\"\u003e\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token namespace\"\u003ebyteorder\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eBigEndian\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eByteOrder\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eLittleEndian\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eReadBytesExt\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"token type-definition class-name\"\u003eBinary\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token lifetime-annotation symbol\"\u003e'a\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    cursor\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eCursor\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan class=\"token lifetime-annotation symbol\"\u003e'a\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eu8\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eimpl\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token lifetime-annotation symbol\"\u003e'a\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBinary\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token lifetime-annotation symbol\"\u003e'a\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003enew\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebytes\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eu8\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBinary\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eBinary\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            cursor\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eCursor\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token function\"\u003enew\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebytes\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003eposition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003emut\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eself\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eu64\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eself\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecursor\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eposition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003eread_little_u16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003emut\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eself\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eResult\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eu16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eError\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eOk\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eself\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecursor\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_u16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eLittleEndian\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003eread_little_u32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003emut\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eself\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eResult\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eu32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eError\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eOk\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eself\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecursor\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_u32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eLittleEndian\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003eread_u16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003emut\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eself\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eResult\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eu16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eError\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eOk\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eself\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecursor\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_u16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eBigEndian\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003eread_u32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003emut\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eself\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eResult\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eu32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eError\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eOk\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eself\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecursor\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_u32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eBigEndian\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003eread_i16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003emut\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eself\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eResult\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ei16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eError\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eOk\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eself\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecursor\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_i16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eBigEndian\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003eread_i32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003emut\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eself\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eResult\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ei32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eError\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eOk\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eself\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecursor\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_i32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eBigEndian\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunwrap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3\u003eパース処理を書いていく\u003c/h3\u003e\n\u003cp\u003e過去にRubyでpsdやzipのパーサを書いたことがあるのですが、これらは仕様書通りの単純な構造だったので、同様に先頭から読み込んでstructに詰めていくだけでいけそうです。\u003cbr\u003e\n今回はzipのヘッダーをパースする処理の書いてみます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-rust\"\u003e\u003ccode class=\"language-rust\"\u003e\u003cspan class=\"token comment\"\u003e// == LocalFileHeader\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e//\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// local file header signature     4 bytes  (0x04034b50)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// version needed to extract       2 bytes\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// general purpose bit flag        2 bytes\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// compression method              2 bytes\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// last mod file time              2 bytes\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// last mod file date              2 bytes\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// crc-32                          4 bytes\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// compressed size                 4 bytes\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// uncompressed size               4 bytes\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// file name length                2 bytes\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// extra field length              2 bytes\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"token type-definition class-name\"\u003eLocalFileHeader\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e signature\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eu32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e version\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eu16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e general_purpose_bit_flag\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eu16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e compression_method\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eu16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e last_modified_file_time\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eu16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e last_modified_file_date\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eu16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e crc_32\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eu32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e compressed_size\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eu32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e uncompressed_size\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eu32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e file_name_length\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eu16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e extra_field_length\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eu16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eimpl\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eLocalFileHeader\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003efrom_bytes\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebytes\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eu8\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eResult\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eLocalFileHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eError\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"token keyword\"\u003emut\u003c/span\u003e binary \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBinary\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003cspan class=\"token function\"\u003enew\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebytes\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e signature \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e binary\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_little_u32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e version \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e binary\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_little_u16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e general_purpose_bit_flag \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e binary\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_little_u16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e compression_method \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e binary\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_little_u16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e last_modified_file_time \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e binary\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_u16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e last_modified_file_date \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e binary\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_u16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e crc_32 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e binary\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_u32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e compressed_size \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e binary\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_u32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e uncompressed_size \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e binary\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_u32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e file_name_length \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e binary\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_u16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e extra_field_length \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e binary\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eread_u16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token class-name\"\u003eOk\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eLocalFileHeader\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            signature\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            version\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            general_purpose_bit_flag\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            compression_method\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            last_modified_file_time\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e last_modified_file_time\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            last_modified_file_date\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            crc_32\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            compressed_size\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            uncompressed_size\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            file_name_length\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            extra_field_length\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eとても簡単ですね。\u003c/p\u003e\n\u003ch2\u003eパースした内容をHTMLにレンダリングする\u003c/h2\u003e\n\u003cp\u003eでは、最後にパースした内容をHTMLへレンダリングしてみます。\u003cbr\u003e\n諸々省略しているのでこのままでは動きませんが、雰囲気としてはこんな感じでDOMを生成して、初めに作ったDomUpdaterのupdateに返り値のVirtualNodeを渡せばOKです。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-rust\"\u003e\u003ccode class=\"language-rust\"\u003e\u003cspan class=\"token comment\"\u003e// let local_file_header = LocalFileHeader::from_bytes(\u0026#x26;bytes)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// let vdom = render(...)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// dom_updater.update(vdom); という感じで使う\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003erender\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003elocal_file_header\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eLocalFileHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eVirtualNode\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token macro property\"\u003ehtml!\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003ediv\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n        \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003espan\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n          signature\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token macro property\"\u003eformat!\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"{:X}\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e local_file_header\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esignature\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n          \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003ebr\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n          version\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token macro property\"\u003eformat!\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"{:X}\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e local_file_header\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eversion\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n          \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003ebr\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n          general_purpose_bit_flag\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token macro property\"\u003eformat!\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"{:X}\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e local_file_header\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003egeneral_purpose_bit_flag\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n          \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003ebr\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n          compression_method\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token macro property\"\u003eformat!\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"{:X}\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e local_file_header\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecompression_method\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n          \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003ebr\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n          last_modified_file_time\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token macro property\"\u003eformat!\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"{:X}\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e local_file_header\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elast_modified_file_time\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n          \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003ebr\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n          last_modified_file_date\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token macro property\"\u003eformat!\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"{:X}\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e local_file_header\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elast_modified_file_date\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n          \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003ebr\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n          crc_32\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token macro property\"\u003eformat!\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"{:X}\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e local_file_header\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecrc_32\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n          \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003ebr\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n        \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003espan\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n      \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003ediv\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eまとめ\u003c/h2\u003e\n\u003cp\u003e今回は\u003ccode\u003ewasm-bindgen\u003c/code\u003eを使ってブラウザでファイルをパースする処理を書いてみました。\u003cbr\u003e\nもう少しパース処理を作り込んでいけば、画像変換やzipの再圧縮などいろいろな処理を書くことができそうです。\u003c/p\u003e\n\u003cp\u003e可能であれば、仕事でもちゃんとRust書いてみたいのでReal Worldの活用事例をもっと知りたいなぁと思いました(´・ω・｀)\u003c/p\u003e","rawContent":"\nこの記事は[Rust Advent Calendar 2020](https://qiita.com/advent-calendar/2020/rust) 21日目の記事です。\n\nお仕事のメインはRuby/TypeScriptを使っていますが、新しいことを学びたいなーと思って、Rustを勉強し始めてみました。  \n今回はWebAssemblyを使って、ブラウザからバイナリファイルをパースする処理を書いてみます。\n\n## RustをWebAssemblyに変換する\n\nこの手の記事は沢山あるので、ざっくりやり方だけ書いておきます。  \n[`wasm-bindgen`](https://github.com/rustwasm/wasm-bindgen)と[`wasm-pack`](https://github.com/rustwasm/wasm-pack)をインストールして、\n\n```\n# Cargo.toml\n[package]\nname = \"app\"\nversion = \"0.0.1\"\nedition = \"2018\"\n\n[lib]\ncrate-type = [\"cdylib\"]\n\n[dependencies]\nwasm-bindgen = \"0.2.63\"\n```\n\n```rust\n# src/lib.rs\nuse wasm_bindgen::prelude::*;\n\n#[wasm_bindgen]\nstruct ApplicationRunner();\n\n#[wasm_bindgen]\nimpl ApplicationRunner {\n    pub fn new() {}\n}\n```\n\n```html\n# index.html\n\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n  \u003chead\u003e\n    \u003cmeta charset=\"UTF-8\"\u003e\n  \u003c/head\u003e\n  \u003cbody\u003e\n    \u003cscript type='module'\u003e\n      import init, { ApplicationRunner } from './app.js'\n\n      (async () =\u003e {\n        await init('/app.wasm')\n        new ApplicationRunner()\n      })()\n    \u003c/script\u003e\n  \u003c/body\u003e\n\u003c/html\u003e\n```\n\nあとは `wasm-pack` を使ってコンパイルすれば完成です。\nめちゃ簡単。\n\n```\n$ wasm-pack build --no-typescript --dev --target web --out-dir ./public\n```\n\n## ファイルを読み込む\n\n続いて、ブラウザから、ファイルを指定してRustにパースさせる導線を作っていきます。  \n先ほど定義した `ApplicationRunner` をnewしたタイミングで、イベントをlistenしたDOMをレンダリングしておきます。\n\nDOMの生成には `virtual_dom_rs` と `web_sys` と `js_sys` を使います。  \nすごく単純な例では、こんな感じでDOMをマウントすることができます。\n\n```rust\nlet vdom = html! { \u003cdiv\u003e\u003c/div\u003e };\nlet window = web_sys::window().unwrap()\nlet dom_updater = DomUpdater::new_append_to_mount(vdom, \u0026window.document().unwrap().body().unwrap());\ndom_updater.update(vdom);\n```\n\n今回はファイルの読み込みをしたいので、vdomの中身を書き換えて、inputタグにイベントを仕込んだDOMにしてみます。\n\n```rust\nhtml! {\n  \u003cinput\n    type=\"file\"\n    onchange=move |event: web_sys::InputEvent| {\n        let target = event.target().unwrap();\n        let input = target.dyn_ref::\u003cHtmlInputElement\u003e().unwrap();\n        let files = input.files().unwrap();\n        let file = files.item(0).unwrap();\n\n        let file_reader = web_sys::FileReader::new().unwrap();\n        file_reader.read_as_array_buffer(\u0026file).unwrap();\n\n        let mut onload = Closure::wrap(Box::new(move |event: Event| {\n            let file_reader: FileReader = event.target().unwrap().dyn_into().unwrap();\n            let file = file_reader.result().unwrap();\n            let file = js_sys::Uint8Array::new(\u0026file);\n\n            let mut bytes = vec![0; file.length() as usize];\n            file.copy_to(\u0026mut bytes);\n\n            // ここにファイルの中身のパースを開始する処理を追加する\n            do_something(\u0026bytes)\n        }) as Box\u003cFnMut(_)\u003e);\n\n        file_reader.set_onload(Some(onload.as_ref().unchecked_ref()));\n        onload.forget();\n    }\n  \u003e\n}\n```\n\n## ファイルをパースする\n\nファイルの読み込みする処理が書けたので、次はファイルをパースしていきます。  \n単にバイナリを読んでいくだけであれば `std::io::Cursor` だけでいけますが、little endianを読み込もうとするとやや操作が面倒です。  \n\nそこで、[byteorder](https://docs.rs/byteorder/1.3.4/byteorder/)を使って読み込んでいきます。  \n下記の例では、今後UTF8の文字列変換や特定のバイナリに特化した読み込みに対応する時に拡張しやすくするために、読み取り用のwrapperを用意しました。  \n単純なzipファイルのパースであれば、file name fieldやextra fieldなどの可変長のfieldがあるため、指定長でvecやstringを返すメソッドも用意するといいかもしれません。\n\n```rust\nuse byteorder::{BigEndian, ByteOrder, LittleEndian, ReadBytesExt};\n\npub struct Binary\u003c'a\u003e {\n    cursor: Cursor\u003c\u0026'a [u8]\u003e,\n}\n\nimpl\u003c'a\u003e Binary\u003c'a\u003e {\n    pub fn new(bytes: \u0026[u8]) -\u003e Binary {\n        Binary {\n            cursor: Cursor::new(bytes),\n        }\n    }\n\n    pub fn position(\u0026mut self) -\u003e u64 {\n        self.cursor.position()\n    }\n\n    pub fn read_little_u16(\u0026mut self) -\u003e Result\u003cu16, Error\u003e {\n        Ok(self.cursor.read_u16::\u003cLittleEndian\u003e().unwrap())\n    }\n\n    pub fn read_little_u32(\u0026mut self) -\u003e Result\u003cu32, Error\u003e {\n        Ok(self.cursor.read_u32::\u003cLittleEndian\u003e().unwrap())\n    }\n\n    pub fn read_u16(\u0026mut self) -\u003e Result\u003cu16, Error\u003e {\n        Ok(self.cursor.read_u16::\u003cBigEndian\u003e().unwrap())\n    }\n\n    pub fn read_u32(\u0026mut self) -\u003e Result\u003cu32, Error\u003e {\n        Ok(self.cursor.read_u32::\u003cBigEndian\u003e().unwrap())\n    }\n\n    pub fn read_i16(\u0026mut self) -\u003e Result\u003ci16, Error\u003e {\n        Ok(self.cursor.read_i16::\u003cBigEndian\u003e().unwrap())\n    }\n\n    pub fn read_i32(\u0026mut self) -\u003e Result\u003ci32, Error\u003e {\n        Ok(self.cursor.read_i32::\u003cBigEndian\u003e().unwrap())\n    }\n}\n```\n\n### パース処理を書いていく\n\n過去にRubyでpsdやzipのパーサを書いたことがあるのですが、これらは仕様書通りの単純な構造だったので、同様に先頭から読み込んでstructに詰めていくだけでいけそうです。  \n今回はzipのヘッダーをパースする処理の書いてみます。\n\n```rust\n// == LocalFileHeader\n//\n// local file header signature     4 bytes  (0x04034b50)\n// version needed to extract       2 bytes\n// general purpose bit flag        2 bytes\n// compression method              2 bytes\n// last mod file time              2 bytes\n// last mod file date              2 bytes\n// crc-32                          4 bytes\n// compressed size                 4 bytes\n// uncompressed size               4 bytes\n// file name length                2 bytes\n// extra field length              2 bytes\nstruct LocalFileHeader {\n    pub signature: u32,\n    pub version: u16,\n    pub general_purpose_bit_flag: u16,\n    pub compression_method: u16,\n    pub last_modified_file_time: u16,\n    pub last_modified_file_date: u16,\n    pub crc_32: u32,\n    pub compressed_size: u32,\n    pub uncompressed_size: u32,\n    pub file_name_length: u16,\n    pub extra_field_length: u16,\n}\n\nimpl LocalFileHeader {\n    pub fn from_bytes(bytes: \u0026[u8]) -\u003e Result\u003cLocalFileHeader, Error\u003e {\n        let mut binary = Binary::new(bytes);\n\n        let signature = binary.read_little_u32()?;\n        let version = binary.read_little_u16()?;\n        let general_purpose_bit_flag = binary.read_little_u16()?;\n        let compression_method = binary.read_little_u16()?;\n        let last_modified_file_time = binary.read_u16()?;\n        let last_modified_file_date = binary.read_u16()?;\n        let crc_32 = binary.read_u32()?;\n        let compressed_size = binary.read_u32()?;\n        let uncompressed_size = binary.read_u32()?;\n        let file_name_length = binary.read_u16()?;\n        let extra_field_length = binary.read_u16()?;\n\n        Ok(LocalFileHeader {\n            signature,\n            version,\n            general_purpose_bit_flag,\n            compression_method,\n            last_modified_file_time: last_modified_file_time,\n            last_modified_file_date,\n            crc_32,\n            compressed_size,\n            uncompressed_size,\n            file_name_length,\n            extra_field_length,\n        })\n    }\n}\n```\n\nとても簡単ですね。\n\n## パースした内容をHTMLにレンダリングする\n\nでは、最後にパースした内容をHTMLへレンダリングしてみます。  \n諸々省略しているのでこのままでは動きませんが、雰囲気としてはこんな感じでDOMを生成して、初めに作ったDomUpdaterのupdateに返り値のVirtualNodeを渡せばOKです。\n\n```rust\n// let local_file_header = LocalFileHeader::from_bytes(\u0026bytes)\n// let vdom = render(...)\n// dom_updater.update(vdom); という感じで使う\nfn render(local_file_header: \u0026LocalFileHeader) -\u003e VirtualNode {\n    html! {\n      \u003cdiv\u003e\n        \u003cspan\u003e\n          signature: {format!(\"{:X}\", local_file_header.signature)}\n          \u003cbr\u003e\n          version: {format!(\"{:X}\", local_file_header.version)}\n          \u003cbr\u003e\n          general_purpose_bit_flag: {format!(\"{:X}\", local_file_header.general_purpose_bit_flag)}\n          \u003cbr\u003e\n          compression_method: {format!(\"{:X}\", local_file_header.compression_method)}\n          \u003cbr\u003e\n          last_modified_file_time: {format!(\"{:X}\", local_file_header.last_modified_file_time)}\n          \u003cbr\u003e\n          last_modified_file_date: {format!(\"{:X}\", local_file_header.last_modified_file_date)}\n          \u003cbr\u003e\n          crc_32: {format!(\"{:X}\", local_file_header.crc_32)}\n          \u003cbr\u003e\n        \u003c/span\u003e\n      \u003c/div\u003e\n    }\n}\n```\n\n## まとめ\n\n今回は`wasm-bindgen`を使ってブラウザでファイルをパースする処理を書いてみました。  \nもう少しパース処理を作り込んでいけば、画像変換やzipの再圧縮などいろいろな処理を書くことができそうです。\n\n可能であれば、仕事でもちゃんとRust書いてみたいのでReal Worldの活用事例をもっと知りたいなぁと思いました(´・ω・｀)\n"},"prevPost":null,"nextPost":{"id":"2020-12-18-kamipo-san-no-advice-to-kyoten-wo-mataida-benkyou-kai","title":"kamipoさんのアドバイスと拠点を跨いだ勉強会","date":"2020-12-18 17:21"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"2020-12-21-rust-advent-calendar"},"buildId":"vyPAX824VGQLIIm6uN-o9","isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-8683bd742a84c1edd48c.js"></script><script src="/_next/static/chunks/webpack-f3dce3d8b4ce9b0f1815.js" async=""></script><script src="/_next/static/chunks/framework-159e6bcedf8862d2ffb2.js" async=""></script><script src="/_next/static/chunks/679-111107f27ddf1c4ca974.js" async=""></script><script src="/_next/static/chunks/778-afdc0fd1e03e237f558b.js" async=""></script><script src="/_next/static/chunks/main-b585fbee1813a2c23693.js" async=""></script><script src="/_next/static/chunks/pages/_app-8034d102492099615e81.js" async=""></script><script src="/_next/static/chunks/a9a7754c-5d9f4b6dc0a2d6223edb.js" async=""></script><script src="/_next/static/chunks/968-ae4b333367f0f3fb3947.js" async=""></script><script src="/_next/static/chunks/625-b9d82b074d475791488b.js" async=""></script><script src="/_next/static/chunks/711-e65fb688a02629edb0f4.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-87066f419f74712c15f1.js" async=""></script><script src="/_next/static/vyPAX824VGQLIIm6uN-o9/_buildManifest.js" async=""></script><script src="/_next/static/vyPAX824VGQLIIm6uN-o9/_ssgManifest.js" async=""></script></body></html>